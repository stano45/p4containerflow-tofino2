#!/usr/bin/env bash
# =============================================================================
# Experiment Configuration
# =============================================================================
# Central configuration for the container migration experiment.
# Source this file from build.sh, cr.sh, clean.sh, etc.
#
# Override any variable by exporting it before sourcing this file:
#   export CONTROLLER_URL=http://192.168.10.2:5000
#   source config.env

# -----------------------------------------------------------------------------
# Hosts
# -----------------------------------------------------------------------------
NUM_HOSTS=${NUM_HOSTS:-3}

# Host 1: client (load generator + metrics collector)
H1_IP=${H1_IP:-10.0.1.1}
H1_MAC=${H1_MAC:-08:00:00:00:01:01}
H1_NET=${H1_NET:-h1-net}
H1_BR=${H1_BR:-h1-br}
H1_SUBNET=${H1_SUBNET:-10.0.1.0/24}
H1_GATEWAY=${H1_GATEWAY:-10.0.1.10}

# Host 2: stream server (initial location)
H2_IP=${H2_IP:-10.0.2.2}
H2_MAC=${H2_MAC:-08:00:00:00:02:02}
H2_NET=${H2_NET:-h2-net}
H2_BR=${H2_BR:-h2-br}
H2_SUBNET=${H2_SUBNET:-10.0.2.0/24}
H2_GATEWAY=${H2_GATEWAY:-10.0.2.20}

# Host 3: migration target
H3_IP=${H3_IP:-10.0.3.3}
H3_MAC=${H3_MAC:-08:00:00:00:03:03}
H3_NET=${H3_NET:-h3-net}
H3_BR=${H3_BR:-h3-br}
H3_SUBNET=${H3_SUBNET:-10.0.3.0/24}
H3_GATEWAY=${H3_GATEWAY:-10.0.3.30}

# -----------------------------------------------------------------------------
# Service Configuration
# -----------------------------------------------------------------------------
# Virtual IP (VIP) for the load balancer â€” clients connect here.
VIP=${VIP:-10.0.1.10}

# HTTP/WebSocket port on the server container
SIGNALING_PORT=${SIGNALING_PORT:-8080}

# Metrics HTTP port on the server container
METRICS_PORT=${METRICS_PORT:-8081}

# Loadgen metrics HTTP port
LOADGEN_METRICS_PORT=${LOADGEN_METRICS_PORT:-9090}

# -----------------------------------------------------------------------------
# Controller
# -----------------------------------------------------------------------------
CONTROLLER_URL=${CONTROLLER_URL:-http://127.0.0.1:5000}

# -----------------------------------------------------------------------------
# P4 Switch Ports
# -----------------------------------------------------------------------------
LAKEWOOD_SW_PORT=${LAKEWOOD_SW_PORT:-140}
LOVELAND_SW_PORT=${LOVELAND_SW_PORT:-148}

# -----------------------------------------------------------------------------
# CRIU / Checkpoint
# -----------------------------------------------------------------------------
CHECKPOINT_DIR=${CHECKPOINT_DIR:-/tmp/checkpoints}

# Path to edit_files_img.py (from p4containerflow or local copy)
EDIT_FILES_IMG=${EDIT_FILES_IMG:-../scripts/edit_files_img.py}

# -----------------------------------------------------------------------------
# Container Images
# -----------------------------------------------------------------------------
SERVER_IMAGE=${SERVER_IMAGE:-stream-server}
LOADGEN_IMAGE=${LOADGEN_IMAGE:-stream-client}
COLLECTOR_IMAGE=${COLLECTOR_IMAGE:-collector}

# -----------------------------------------------------------------------------
# Metrics Collection
# -----------------------------------------------------------------------------
RESULTS_DIR=${RESULTS_DIR:-results}
METRICS_INTERVAL=${METRICS_INTERVAL:-1s}
MIGRATION_FLAG_FILE=${MIGRATION_FLAG_FILE:-/tmp/migration_event}

# -----------------------------------------------------------------------------
# Load Generator
# -----------------------------------------------------------------------------
# Number of concurrent WebSocket connections
LOADGEN_CONNECTIONS=${LOADGEN_CONNECTIONS:-4}
# Duration of the load test (0 = until killed)
LOADGEN_DURATION=${LOADGEN_DURATION:-0}
