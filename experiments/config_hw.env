#!/usr/bin/env bash
# Hardware config — multi-node experiment on lakewood/loveland/tofino

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/config.env"

# SSH targets
LAKEWOOD_SSH=${LAKEWOOD_SSH:-kosorins32@lakewood.ct.univie.ac.at}
LOVELAND_SSH=${LOVELAND_SSH:-kosorins32@loveland.ct.univie.ac.at}
TOFINO_SSH=${TOFINO_SSH:-kosorins32@wedge100bf.ct.univie.ac.at}
SSH_OPTS="-o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=10"

# Macvlan network on Netronome NICs (192.168.12.0/24 — same L2 as P4 switch)
HW_SUBNET=192.168.12.0/24
HW_GATEWAY=192.168.12.1
HW_NET=switch-net
LAKEWOOD_NIC=${LAKEWOOD_NIC:-enp101s0np1}
LOVELAND_NIC=${LOVELAND_NIC:-enp101s0np1}

# Direct server-to-server link (Mellanox 25G, for checkpoint transfer)
LAKEWOOD_DIRECT_IP=${LAKEWOOD_DIRECT_IP:-192.168.10.2}
LOVELAND_DIRECT_IP=${LOVELAND_DIRECT_IP:-192.168.10.3}
LAKEWOOD_DIRECT_IF=${LAKEWOOD_DIRECT_IF:-enp179s0f0np0}
LOVELAND_DIRECT_IF=${LOVELAND_DIRECT_IF:-enp179s0f0}

# Host IPs on the Netronome subnet
VIP=192.168.12.10
H1_IP=192.168.12.100
H1_MAC=02:42:c0:a8:0c:64
H2_IP=192.168.12.2
H2_MAC=02:42:c0:a8:0c:02
H3_IP=192.168.12.3
H3_MAC=02:42:c0:a8:0c:03

# Macvlan-shim: host-side interface on lakewood for host↔container communication.
# Without this, Linux macvlan isolation blocks host access to its own containers.
MACSHIM_IF=${MACSHIM_IF:-macshim}

# Controller on the Tofino switch
CONTROLLER_URL=http://131.130.124.74:5000
CONTROLLER_CONFIG=controller_config_hw.json

# CRIU / Checkpoint
CHECKPOINT_DIR=/tmp/checkpoints
REMOTE_EDIT_SCRIPT=${REMOTE_EDIT_SCRIPT:-/home/kosorins32/p4containerflow-tofino2/scripts/edit_files_img.py}
REMOTE_EDIT_BIN=${REMOTE_EDIT_BIN:-/tmp/edit_checkpoint}
CR_SKIP_VERIFY=${CR_SKIP_VERIFY:-1}
CR_SKIP_IMAGE_CHECK=${CR_SKIP_IMAGE_CHECK:-1}

# Experiment project root on lab nodes
REMOTE_PROJECT_DIR=${REMOTE_PROJECT_DIR:-/home/kosorins32/p4containerflow-tofino2}
