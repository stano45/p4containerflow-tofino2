#!/usr/bin/env bash
# =============================================================================
# Hardware Configuration — Multi-Node Experiment
# =============================================================================
# All scripts run from your dev/control machine and SSH into the lab nodes.
#
# Topology:
#   control machine (you) --SSH--> lakewood  (client + server)
#   control machine (you) --SSH--> loveland  (migration target)
#   control machine (you) --SSH--> tofino    (switch + controller)
#
# Usage:
#   source config_hw.env
# =============================================================================

# Load base defaults first
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/config.env"

# -----------------------------------------------------------------------------
# SSH targets (from your control machine)
# -----------------------------------------------------------------------------
LAKEWOOD_SSH=${LAKEWOOD_SSH:-kosorins32@lakewood.ct.univie.ac.at}
LOVELAND_SSH=${LOVELAND_SSH:-kosorins32@loveland.ct.univie.ac.at}
TOFINO_SSH=${TOFINO_SSH:-kosorins32@wedge100bf.ct.univie.ac.at}

SSH_OPTS="-o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=10"

# -----------------------------------------------------------------------------
# Network — macvlan on Netronome NICs
# Containers get their own MAC and IP on the physical subnet (192.168.12.0/24)
# so the Tofino P4 switch can forward traffic to them by IP. Bridge networking
# would NAT or use a different segment; macvlan puts containers on the same L2
# as the switch for direct routing and migration (same subnet before/after move).
# -----------------------------------------------------------------------------
HW_SUBNET=192.168.12.0/24
HW_GATEWAY=192.168.12.1
HW_NET=switch-net

# Netronome NICs (physical interfaces for macvlan)
LAKEWOOD_NIC=${LAKEWOOD_NIC:-enp101s0np1}
LOVELAND_NIC=${LOVELAND_NIC:-enp101s0np0}

# Direct server-to-server link (Mellanox 25G DAC, see topology.md). Checkpoint transfer uses netcat
# over this when the interface is up; otherwise falls back to rsync over SSH.
LAKEWOOD_DIRECT_IP=${LAKEWOOD_DIRECT_IP:-192.168.10.2}
LOVELAND_DIRECT_IP=${LOVELAND_DIRECT_IP:-192.168.10.3}
LAKEWOOD_DIRECT_IF=${LAKEWOOD_DIRECT_IF:-enp179s0f0np0}
LOVELAND_DIRECT_IF=${LOVELAND_DIRECT_IF:-enp179s0f0}

# -----------------------------------------------------------------------------
# Hosts — real IPs on the Netronome subnet
# -----------------------------------------------------------------------------
VIP=192.168.12.10

# Host 1: client (load generator) — on lakewood
H1_IP=192.168.12.100
H1_MAC=02:42:c0:a8:0c:64   # macvlan-generated

# Host 2: WebRTC server (initial) — on lakewood
H2_IP=192.168.12.2
H2_MAC=02:42:c0:a8:0c:02   # macvlan-generated

# Host 3: migration target — on loveland
H3_IP=192.168.12.3
H3_MAC=02:42:c0:a8:0c:03   # macvlan-generated

# -----------------------------------------------------------------------------
# Controller — runs on the Tofino switch
# -----------------------------------------------------------------------------
# NOTE: controller URL uses the IP since curl needs a routable address.
# If you're outside the university network, you may need to tunnel:
#   ssh -L 5000:localhost:5000 kosorins32@wedge100bf.ct.univie.ac.at
CONTROLLER_URL=${CONTROLLER_URL:-http://131.130.124.74:5000}

# Controller config file (relative to controller/ dir on tofino)
CONTROLLER_CONFIG=controller_config_hw.json

# -----------------------------------------------------------------------------
# CRIU / Checkpoint — cross-node
# -----------------------------------------------------------------------------
# Checkpoint dir on lakewood (source) and loveland (target)
CHECKPOINT_DIR=/tmp/checkpoints

# Path to edit_files_img.py on the remote nodes (fallback if Rust binary not used)
REMOTE_EDIT_SCRIPT=${REMOTE_EDIT_SCRIPT:-/home/kosorins32/p4containerflow-tofino2/scripts/edit_files_img.py}
# Optional: path to edit_checkpoint Rust binary on target (faster than Python). Set by run_experiment.sh when built.
REMOTE_EDIT_BIN=${REMOTE_EDIT_BIN:-/tmp/edit_checkpoint}
# Skip post-transfer size verify to save ~1 SSH RTT (direct link is reliable)
CR_SKIP_VERIFY=${CR_SKIP_VERIFY:-1}
# Skip image-exists check on target during pre-transfer (image synced at experiment setup)
CR_SKIP_IMAGE_CHECK=${CR_SKIP_IMAGE_CHECK:-1}

# -----------------------------------------------------------------------------
# Experiment project root on each lab node
# -----------------------------------------------------------------------------
REMOTE_PROJECT_DIR=${REMOTE_PROJECT_DIR:-/home/kosorins32/p4containerflow-tofino2}
